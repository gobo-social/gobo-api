shards:
  id: &id
    id:
      description: The unique identifier for this resource.
      type: integer

  string_id: &string_id
    id:
      description: The unique identifier for this resource.
      type: string

  person_id: &person_id
    person_id:
      description: The unique ID for the person that owns this resource.
      type: integer

  timestamp: &timestamp
    created:
      description: The ISO 8601 timestamp this resource was created.
      type: string
    updated:
      description: The ISO 8601 timestamp this resource was updated.
      type: string

  linkCore: &linkCore
    origin_type:
      description: The type of resource that represents the origin of this edge.
      type: string
    origin_id:
      description: The unique identifier for the resource.
      type: integer
    target_type:
      description: The type of resource that represents the target of this edge.
      type: string
    target_id:
      description: The uniuqe identifier for the resource.
      type: integer
    name:
      description: The name that describes the type of edge between these resources.
      type: string
    secondary:
      description: A secondary dimension projected into this edge, suitable for sorting a given family of edges.
      type: string

  link: &link
    type: object
    additionalProperties: false
    required: [ id, origin_type, origin_id, target_type, target_id, name ]
    properties:
      <<: *id
      <<: *linkCore
      <<: *timestamp

  taskCore: &taskCore
    queue:
      description: The name of the queue family that should handle this task.
      type: string
    name:
      description: The name describing this task operation.
      type: string
    details:
      description: The payload of information relevant to completing this task.
      type: object

  task: &task
    type: object
    additionalProperties: false
    required: [id]
    properties:
      <<: *id
      <<: *taskCore
      <<: *timestamp


  personCore: &personCore
    name:
      description: Chosen display name for this person.
      type: string
    authority_id:
      description: The unique identifier for this person within the authentication authority
      type: string

  person: &person
    type: object
    additionalProperties: false
    required: [ id ]
    properties:
      <<: *id
      <<: *personCore
      <<: *timestamp

  storeCore: &storeCore
    <<: *person_id
    name:
      type: string
    content:
      type: object

  store: &store
    type: object
    additionalProperties: false
    properties:
      <<: *id
      <<: *storeCore
      <<: *timestamp

  identityCore: &identityCore
    <<: *person_id
    platform_id:
      description: The unique ID for this identity on the host provider.
      type: string
    base_url:
      description: The base URL of the service provider of this identity.
      type: string
    profile_url:
      description: The URL pointing to this identity on the host provider.
      type: string
    profile_image:
      description: The URL pointing to this idenity profile picture on the host provider.
      type: string
    username:
      description: The username associated with this identity.
      type: string
    name:
      description: The display name associated with this identity.
      type: string
    oauth_token:
      description: The OAuth token associated with this identity.
      type: string
    oauth_token_secret:
      description: The OAuth secret token associated with this identity access.
      type: string
    active:
      description: This flag provides a hint as to the visibility of posts from this identity in certain feeds.
      type: boolean

  identity: &identity
    type: object
    additionalProperties: false
    required: [id, person_id, base_url, profile_url, username]
    properties:
      <<: *id
      <<: *identityCore
      <<: *timestamp

  registrationCore: &registrationCore
    <<: *person_id
    base_url:
      description: The base URL of the service provider of this registration.
      type: string
    oauth_token:
      description: The OAuth token associated with this registration.
      type: string
    oauth_token_secret:
      description: The OAuth secret token associated with this registration access.
      type: string
    state:
      description: The current state of the registration.
      type: string
   
  
  registration: &registration
    type: object
    additionalProperties: false
    required: [id, person_id, base_url]
    properties:
      <<: *id
      <<: *registrationCore
      <<: *timestamp

  mastodonClientCore: &mastodonClientCore
    base_url:
      description: The base URL of the service provider of this Mastodon client.
      type: string
    client_id:
      description: The OAuth client ID associated with this client.
      type: string
    client_secret:
      description: The OAuth client secret associated with this client.
      type: string   
  
  mastodonClient: &mastodonClient
    type: object
    additionalProperties: false
    required: [id, base_url]
    properties:
      <<: *id
      <<: *mastodonClientCore
      <<: *timestamp

  lensCore: &lensCore
    <<: *person_id
    category:
      description: Describes the type of lens and controls how it acts on the feed
      type: string
    active:
      description: This flag provides a hint as to this lens effect on a given feed.
      type: boolean
    configuration:
      description: Description of a given lens configuration. Varies based on lens category.
      type: object

  lens: &lens
    type: object
    additionalProperties: false
    required: [ id, person_id ]
    properties:
      <<: *id
      <<: *lensCore
      <<: *timestamp

  sourceCore: &sourceCore
    platform_id:
      description: The ID of this entity within the given platform.
      type: string
    base_url:
      description: The base URL of the source, pointing to its platform
      type: string
    url:
      description: The full, unique URL for this source
      type: string
    username:
      description: The platform unique name for a source
      type: string
    name:
      description: The platform display name for a source
      type: string
    icon_url:
      type: string
    active:
      description: Flag to control whether this source is actively used to build feeds.
      type: boolean

  source: &source
    type: object
    additionalProperties: false
    required: [id]
    properties:
      <<: *id
      <<: *sourceCore
      <<: *timestamp


  postCore: &postCore
    source_id:
      description: The unique ID of the source for this post.
      type: integer
    base_url:
      description: The base URL for the platform that hosts this post.
      type: string
    platform_id:
      description: The ID of this post, unique to the platform that hosts it.
      type: string
    title:
      type: string
    content:
      type: string
    url:
      description: The URL of the original post, hosted by the platform
      type: string
    visibility:
      description: Describes how publicly visible this post is
      type: string
    published:
      description: The ISO 8601 timestamp this post was published on the host platform.
      type: string
    attachments:
      description: List of URLs where you can find media attachments for this post.
      type: array
      items: 
        type: object
    poll:
      description: Data related to a poll attached to this post. Contains the timestamp for the poll ending and data on the vote tally when last fetch.
      type: object

  post: &post
    type: object
    additionalProperties: false
    required: [id]
    properties:
      <<: *id
      <<: *postCore
      <<: *timestamp

  imageCore: &imageCore    
    id:
      description: Unqiue identifier for the uploaded image to GOBO cross-posting
      type: string
    person_id:
      description: The ID of the person this draft image is associated with.
      type: integer
    mime_type:
      description: MIME type of this image
      type: string
    name:
      description: Provided name for this image.
      type: string
    alt:
      description: Provided alt text for this image
    published:
      description: flag indicated whether this image has been used in a post publish task
      type: boolean

  image: &image
    type: object
    additionalProperties: false
    required: [ id, person_id ]
    properties:
      <<: *imageCore
      <<: *timestamp

  newPost: &newPost
    type: object
    additionalProperties: false
    required: [ targets, post ]
    properties:
      targets:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [ identity ]
          properties:
            identity:
              description: The ID of the target identity. GOBO will create a post on your behalf with this provider.
              type: integer
            metadata:
              description: Platform specific configuration needed to create this post. For example, a target subreddit.
              type: object
      post:
        type: object
        additionalProperties: false
        required: [ content ]
        properties:
          title:
            type: string
          content:
            type: string
          attachments:
            description: List of draft image IDs to provide as attachments in the final post.
            type: array
            items: 
              type: string
          poll:
            description: Data related to a poll attached to this post. Contains the timestamp for the poll ending and data on the vote tally when last fetch.
            type: object   

  postEdgeCore: &postEdgeCore
    identity:
      description: The ID of the edge origin identity
      type: integer
    post:
      description: The ID of the edge target post
      type: integer
    name:
      description: The name of edge connecting these vertices.
      type: string
      enum:
        - like
        - upvote
        - downvote
        - repost
      

  postEdge: &postEdge
    type: object
    additionalProperties: false
    required: [ id, identity, post, edge ]
    properties:
      <<: *id
      <<: *postEdgeCore
      <<: *timestamp
     

resources:
  discovery:
    template: /
    route: /
    methods:
      get:
        request:
          authorization: [ public ]
        response:
          type: application/json
          status: 200

  links:
    template: /links{?view,direction,per_page,page,origin_type,origin_id,target_type,target_id,name}
    route: /links
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            required: [ origin_type, origin_id, target_type, target_id, name ]
            properties: *linkCore
        response:
          type: application/json
          schema: *link
          status: 201

      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *link


  link:
    template: /links/{id}
    route: /links/<int:id>
    methods:
      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema: *link

      put:
        request:
          type: application/json
          schema: *link
        response:
          type: application/json
          status: 200
          schema: *link

      delete:
        request: {}
        response:
          status: 204


  tasks:
    template: /tasks{?view,direction,per_page,page}
    route: /tasks
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            properties: *taskCore
        response:
          type: application/json
          schema: *task
          status: 201

      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *task


  task:
    template: /tasks/{id}
    route: /tasks/<int:id>
    methods:
      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema: *task

      put:
        request:
          type: application/json
          schema: *task
        response:
          type: application/json
          status: 200
          schema: *task

      delete:
        request: {}
        response:
          status: 204


  people:
    template: /people{?view,direction,per_page,page}
    route: /people
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            properties: *personCore
        response:
          type: application/json
          schema: *person
          status: 201

      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *person


  person:
    template: /people/{id}
    route: /people/<int:id>
    methods:
      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema: *person

      put:
        request:
          type: application/json
          schema: *person
        response:
          type: application/json
          status: 200
          schema: *person

      delete:
        request: {}
        response:
          status: 204


  identities:
    template: /identities{?view,direction,per_page,page}
    route: /identities
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            required: [person_id, base_url, username, profile_url]
            properties: *identityCore
        response:
          type: application/json
          schema: *identity
          status: 201

      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *identity


  identity:
    template: /identities/{id}
    route: /identities/<int:id>
    methods:
      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema: *identity

      put:
        request:
          type: application/json
          schema: *identity
        response:
          type: application/json
          status: 200
          schema: *identity

      delete:
        request: {}
        response:
          status: 204

  registrations:
    template: /registrations{?view,direction,per_page,page}
    route: /registrations
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            required: [person_id, base_url]
            properties: *registrationCore
        response:
          type: application/json
          schema: *registration
          status: 201

      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *registration


  registration:
    template: /registrations/{id}
    route: /registrations/<int:id>
    methods:
      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema: *registration

      put:
        request:
          type: application/json
          schema: *registration
        response:
          type: application/json
          status: 200
          schema: *registration

      delete:
        request: {}
        response:
          status: 204


  mastodon_clients:
    template: /mastodon_clients{?view,direction,per_page,page}
    route: /mastodon_clients
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            properties: *mastodonClientCore
        response:
          type: application/json
          schema: *mastodonClient
          status: 201

      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *mastodonClient


  mastodon_client:
    template: /mastodon_clients/{id}
    route: /mastodon_clients/<int:id>
    methods:
      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema: *mastodonClient

      put:
        request:
          type: application/json
          schema: *mastodonClient
        response:
          type: application/json
          status: 200
          schema: *mastodonClient

      delete:
        request: {}
        response:
          status: 204

  lenses:
    template: /lenses{?view,direction,per_page,page}
    route: /lenses
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            properties: *lensCore
        response:
          type: application/json
          schema: *lens
          status: 201

      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *lens


  lens:
    template: /lenses/{id}
    route: /lenses/<int:id>
    methods:
      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema: *lens

      put:
        request:
          type: application/json
          schema: *lens
        response:
          type: application/json
          status: 200
          schema: *lens

      delete:
        request: {}
        response:
          status: 204

  sources:
    template: /sources{?view,direction,per_page,page}
    route: /sources
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            properties: *sourceCore
        response:
          type: application/json
          schema: *source
          status: 201

      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *source


  source:
    template: /source/{id}
    route: /source/<int:id>
    methods:
      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema: *source

      put:
        request:
          type: application/json
          schema: *source
        response:
          type: application/json
          status: 200
          schema: *source

      delete:
        request: {}
        response:
          status: 204

  posts:
    template: /posts{?view,direction,per_page,page}
    route: /posts
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            properties: *postCore
        response:
          type: application/json
          schema: *post
          status: 201

      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *post


  post:
    template: /post/{id}
    route: /post/<int:id>
    methods:
      get:
        request: {}
        response:
          type: application/json
          status: 200
          schema: *post

      put:
        request:
          type: application/json
          schema: *post
        response:
          type: application/json
          status: 200
          schema: *post

      delete:
        request: {}
        response:
          status: 204

  me:
    template: /auth/me
    route: /auth/me
    methods:
      get:
        request:
          authorization:
            - general
        response:
          type: application/json
          status: 200
          schema: *person

      put:
        request:
          type: application/json
          schema: *person
        response:
          type: application/json
          status: 200
          schema: *person

  person_store:
    template: /people/{person_id}/stores/{name}
    route: /people/<int:person_id>/stores/<name>
    methods:
      get:
        request:
          authorization:
            - person
        response:
          status: 200
          type: application/json
          schema: *store

      delete:
        request: {}
        response:
          status: 204

      put:
        request:
          authorization:
            - person
          type: application/json
          schema: *store
        response:
          status: 200
          type: application/json
          schema: *store

  person_identities:
    template: /people/{person_id}/identities{?per_page,page}
    route: /people/<int:person_id>/identities
    methods:
      get:
        request:
          authorization:
            - person
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *identity

  person_identity:
    template: /people/{person_id}/identities/{id}
    route: /people/<int:person_id>/identities/<int:id>
    methods:
      post:
        request:
          authorization:
            - person
          type: application/json
          schema:
            type: object
            additionalProperties: false
            required: [ active ]
            properties:
              active:
                description: Controls the visibility of the feed emenating from this identity in the full feed.
                type: boolean
        response:
          status: 200
          type: application/json
          schema: *identity

      delete:
        request:
          authorization:
            - person
        response:
          status: 204

  person_lenses:
    template: /people/{person_id}/lenses{?per_page,page}
    route: /people/<int:person_id>/lenses
    methods:
      get:
        request:
          authorization:
            - person
        response:
          type: application/json
          status: 200
          schema:
            type: array
            items: *lens

      post:
        request:
          authorization:
            - person
          type: application/json
          schema:
            type: object
            additionalProperties: false
            properties: *lensCore
        response:
          type: application/json
          status: 201
          schema: *lens

  person_lens:
    template: /people/{person_id}/lenses/{id}{?per_page,page,category}
    route: /people/<int:person_id>/lenses/<int:id>
    methods:
      put:
        request:
          authorization:
            - person
          type: application/json
          schema: *lens
        response:
          status: 200
          type: application/json
          schema: *lens

      delete:
        request:
          authorization:
            - person
        response:
          status: 204

  person_identity_feed:
    template: /people/{person_id}/identities/{id}/feed{?per_page,start}
    route: /people/<int:person_id>/identities/<int:id>/feed
    methods:
      get:
        request:
          authorization:
            - person
        response:
          type: application/json
          status: 200
          schema:
            type: object
            additionalProperties: false
            required: [ feed, posts, sources ]
            properties:
              feed:
                description: Array of ordered post IDs for this feed. The order depends on the feed being requested.
                type: array
                items:
                  type: integer
              posts:
                description: List of posts that appear somewhere in this feed segment.
                type: array
                items: *post
              post_edges:
                description: List of post references that have a relationship with this identity.
                type: array
                items:
                  type: array
                  items:
                    type: integer
              shares:
                description: List of post references that have share relationships.
                type: array
                items:
                  type: array
                  items:
                    type: integer
              replies:
                description: List of post references that have reply relationships.
                type: array
                items:
                  type: array
                  items:
                    type: integer
              sources:
                description: List of sources that appear somewhere in this feed segment.
                type: array
                items: *source
              next:
                description: token that allows the client to fetch the next page fo the feed.
                type: string

  person_identity_post:
    template: /people/{person_id}/identities/{identity_id}/post/{id}
    route: /people/<int:person_id>/identities/<int:identity_id>/post/<int:id>
    methods:
      get:
        request:
          authorization:
            - person
        response:
          type: application/json
          status: 200
          schema:
            type: object
            additionalProperties: false
            required: [ feed, posts, sources ]
            properties:
              feed:
                description: Array of ordered post IDs for this feed. The order depends on the feed being requested.
                type: array
                items:
                  type: integer
              posts:
                description: List of posts that appear somewhere in this feed segment.
                type: array
                items: *post
              post_edges:
                description: List of post references that have a relationship with this identity.
                type: array
                items:
                  type: array
                  items:
                    type: integer
              shares:
                description: List of post references that have share relationships.
                type: array
                items:
                  type: array
                  items:
                    type: integer
              replies:
                description: List of post references that have reply relationships.
                type: array
                items:
                  type: array
                  items:
                    type: integer
              sources:
                description: List of sources that appear somewhere in this feed segment.
                type: array
                items: *source

  person_draft_images:
    template: /people/{person_id}/draft-images
    route: /people/<int:person_id>/draft-images
    methods:
      post:
        description: "Accepts mutlipart upload of image. Form fields are 'file', 'name', and 'alt'."
        request:
          authorization:
            - person
          type: multipart/form-data
        response:
          status: 200
          type: application/json
          schema: *image

  person_draft_image:
    template: /people/{person_id}/draft-images/{id}
    route: /people/<int:person_id>/draft-images/<id>
    methods:
      delete:
        request:
          authorization:
            - person
        response:
          status: 204

  person_posts:
    template: /people/{person_id}/posts
    route: /people/<int:person_id>/posts
    methods:
      post:
        request:
          authorization:
            - person
          type: application/json
          schema: *newPost
        response:
          status: 200
          type: application/json
          schema: 
            type: array
            items: *task

  person_post_edge:
    template: /people/{person_id}/post-edges/{identity_id}/{post_id}/{name}
    route: /people/<int:person_id>/post-edges/<int:identity_id>/<int:post_id>/<name>
    methods:
      put:
        request:
          authorization:
            - person
        response:
          status: 200
          type: application/json
          schema: *postEdge

      delete:
        request:
          authorization:
            - person
        response:
          status: 204

  action_onboard_identity_start:
    template: /actions/onboard-identity
    route: /actions/onboard-identity
    methods:
      post:
        request:
          authorization:
            - general
          type: application/json
          schema:
            type: object
            additionalProperties: false
            required: [ base_url ]
            properties:
              base_url:
                description: The base URL that identifies the target social media provider.
                type: string

        response:
          type: application/json
          status: 200
          schema:
            type: object
            additionalProperties: false
            properties:
              redirect_url:
                description: The URL the GOBO client should redirect the browser so the person may login
                type: string
              state:
                description: For Bluesky, we don't make use of a redirect flow. Use this nonce to give us some flow integrity. 

  action_onboard_identity_callback:
    template: /actions/onboard-identity-callback
    route: /actions/onboard-identity-callback
    methods:
      post:
        request:
          authorization:
            - general
          type: application/json
          schema:
            type: object
            additionalProperties: false
            required: [ base_url ]
            properties:
              base_url:
                description: The base URL that identifies the target social media provider.
                type: string
              code:
                description: Required for Reddit and Mastodon. Querystring parameter provided in the authentication callback.
                type: string 
              state:
                description: Required for Bluesky and Reddit. Querystring parameter provided in the authentication callback.
                type: string
              bluesky_login:
                description: >
                  Required for Bluesky. The login identifier for this person's account on Bluesky. Example: person.bsky.social
                type: string
              bluesky_secret:
                description: >
                  Required for Bluesky. An "App Password" created for GOBO. Do NOT put root password here.
                type: string

        response:
          status: 200
          type: application/json
          schema: *identity

  action_pull_identity_sources:
    template: /actions/pull-identity-sources
    route: /actions/pull-identity-sources
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
            additionalProperties: false
            required: [ profile_url ]
            properties:
              profile_url:
                description: The unique URL of this identity with the host provider.
                type: string
        response:
          status: 200
          type: application/json
          schema: *task

  action_workbench:
    template: /actions/workbench
    route: /actions/workbench
    methods:
      post:
        request:
          type: application/json
          schema:
            type: object
        response:
          status: 200
          type: application/json
          schema: *task